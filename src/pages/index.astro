---
import type { Column as ColumnType, User, TaskStatus } from "@/types";
import Layout from "../layouts/Layout.astro";
import Board from "../components/Board.vue";
import { Collaborators, Column, db, KanbanBoard, Comment as CommentTable } from "astro:db";
import type { Comment } from "@/types";

const collaborators: User[] = await db.select().from(Collaborators);
// Fetch columns and their tasks to match the Column type
const columnsRaw = await db.select().from(Column);
// Assuming you have a Task table and a way to fetch tasks by column
import { Task } from "astro:db";
import { eq } from "astro:db";

const columns: ColumnType[] = await Promise.all(
  columnsRaw.map(async (col) => {
    const tasksRaw = await db.select().from(Task).where(eq(Task.columnId, col.id));
    const tasks = tasksRaw.map((task) => ({
      id: task.id,
      title: task.title,
      status: task.status as TaskStatus,
      type: task.type as any,
      description: task.description,
      summary: task.summary,
      assignee: task.assignee,
      dueDate: task.dueDate,
      priority: task.priority as any,
      createdAt: task.createdAt,
      updatedAt: task.updatedAt,
    }));
    return {
      id: col.id,
      boardId: col.boardId,
      title: col.title,
      status: col.status as TaskStatus,
      tasks: tasks,
    };
  })
);

const commentsRaw = await db.select().from(CommentTable);
const comments = commentsRaw.map((comment) => ({
  id: comment.id,
  taskId: comment.taskId,
  author: comment.author,
  content: comment.content,
  createdAt: comment.createdAt,
  updatedAt: comment.updatedAt,
}));

// Map boards to include missing properties for KanbanBoard type
const boardsRaw = await db.select().from(KanbanBoard);
const boards = boardsRaw.map((board) => ({
  ...board,
  name: board.boardName, // Assuming boardName is the name
  columns: columns.filter((col) => col.boardId === board.id),
  tasks: columns.filter((col) => col.boardId === board.id).flatMap((col) => col.tasks), // Only tasks for this board
  users: [], // Dummy property to satisfy KanbanBoard type
}));
---

<Layout title="Kanban Board">
  <Board client:only="vue" boards={boards} collaborators={collaborators} columns={columns} comments={comments} />
</Layout>
